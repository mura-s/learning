:imagesdir: images

== ハンズオン
=== 概要
スレッドセーフではないプログラムの挙動を確認した後、スレッドセーフな作りに修正します。

=== 手順
. CalculateControllerクラスの中身を見てみましょう。どのような処理を行っているか分かりますか？また、何か問題を感じませんか？

. calculatePriceメソッドの中の、totalを計算した後にブレークポイントを設定し、CalculateApplicationクラスをデバッグモードで起動しましょう。
+
NOTE: Intellij IDEAを使用している場合、ブレークポイントの設定を以下のように「Thread」にする必要があります。
+
image::thread.png[]

. ブラウザで http://localhost:8080/calculate-price?a=100&b=200&c=300 にアクセスします。１つのスレッドで処理が止まるはずです。totalの変数の中身は「600」になっています。

. ブラウザを新たに起動し、 http://localhost:8080/calculate-price?a=200&b=300&c=400 にアクセスします。別のスレッドで処理が止まるはずです。このとき、totalの変数の中身は「900」になっています。

. 最初のスレッドの処理を再開しましょう。画面に「990」が表示されます。本来なら、「660」のはずですが、後から動いた処理によってtotal変数の中身が上書きされたためです。つまり、スレッドセーフな作りになっていません。

. スレッドセーフな作りにするにはどうすればよいでしょう？作り直してみましょう。